#!/bin/bash

# Konfigurasi Database
DB_NAME=${DKA_DB_NAME:-test}
DB_USER=${DKA_DB_USERNAME:-test}
DB_PASSWORD=${DKA_DB_PASSWORD:-test}
DB_HOST=${DKA_DB_HOST:-localhost} # Sebaiknya tambahkan host
BACKUP_DIR="/backup"
DATE=$(date +%d-%m-%Y_%H-%M-%S)
BACKUP_FILE="$BACKUP_DIR/${DB_NAME}_$DATE.sql.gz"

mkdir -p $BACKUP_DIR
export PGPASSWORD=$DB_PASSWORD

echo "Backing up database: $DB_NAME..."

# Menggunakan pg_dump dengan proteksi maksimal terhadap User & PostGIS
pg_dump -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" \
    --no-owner \
    --no-privileges \
    --no-extension \
    --clean \
    --if-exists \
    | gzip -9 > "$BACKUP_FILE"

# Mengecek status berhasil/gagal menggunakan PIPESTATUS
if [ ${PIPESTATUS[0]} -eq 0 ]; then
    echo "Backup completed successfully: $BACKUP_FILE"
else
    echo "Backup failed."
    # Hapus file backup yang korup/kosong jika gagal
    rm -f "$BACKUP_FILE"
fi
#!/bin/bash

# 1. Konfigurasi - Mengambil dari Environment Variables yang Anda tentukan
DB_NAME=${DKA_DB_NAME:-test}
DB_USER=${DKA_DB_USERNAME:-test}
DB_PASSWORD=${DKA_DB_PASSWORD:-test}
DB_HOST=${DKA_DB_HOST:-localhost}
BACKUP_DIR="/backup"

# 2. Ambil list file backup (Top 50 terbaru)
# shellcheck disable=SC2207
BACKUP_FILES=($(ls -1t $BACKUP_DIR/*.sql.gz 2>/dev/null | head -n 50))

if [ ${#BACKUP_FILES[@]} -eq 0 ]; then
    echo "Error: Tidak ada file backup di $BACKUP_DIR"
    exit 1
fi

echo "--- Daftar Backup Tersedia (Database Target: $DB_NAME) ---"
PS3="Pilih nomor file untuk di-restore: "

MENU_OPTIONS=()
for file in "${BACKUP_FILES[@]}"; do
    FILE_SIZE=$(du -h "$file" | awk '{print $1}')
    # Mengambil nama file utuh agar tidak salah saat gunzip
    MENU_OPTIONS+=("$(basename "$file") ($FILE_SIZE)")
done

select OPTION in "${MENU_OPTIONS[@]}"; do
    if [ -n "$OPTION" ]; then
        # Ambil nama file dari pilihan (string sebelum spasi pertama)
        SELECTED_FILE=$(echo "$OPTION" | awk '{print $1}')
        break
    else
        echo "Pilihan tidak valid."
    fi
done

SELECTED_BACKUP_PATH="$BACKUP_DIR/$SELECTED_FILE"
export PGPASSWORD=$DB_PASSWORD

echo "----------------------------------------------------------"
echo "Memulai Restore ke Host: $DB_HOST | Database: $DB_NAME"
echo "File: $SELECTED_FILE"
echo "----------------------------------------------------------"

# 3. Proses Restore Data
# Langsung melakukan streaming gunzip ke psql
echo "Mengimpor data sedang berlangsung..."
gunzip < "$SELECTED_BACKUP_PATH" | psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME"

# Mengecek status exit dari psql (elemen ke-2 dalam pipeline)
if [ ${PIPESTATUS[1]} -eq 0 ]; then
    echo "----------------------------------------------------------"
    echo "✅ SUCCESS: Restore ke database '$DB_NAME' selesai."
else
    echo "----------------------------------------------------------"
    echo "❌ ERROR: Restore gagal."
    echo "Pastikan database '$DB_NAME' sudah ada dan user memiliki akses."
fi
#!/bin/bash
set -e

# --- KONFIGURASI ---
export GZIP=-9
DKA_MONGO_USERNAME=${DKA_MONGO_USERNAME:-root}
DKA_MONGO_PASSWORD=${DKA_MONGO_PASSWORD:-123456789}
DKA_HOSTNAME=$(hostname)

# Direktori tujuan backup
BACKUP_DIR="/backup"
TIMESTAMP=$(date +"%H-%M-%S_%d-%m-%Y")
ARCHIVE_FILE="${DKA_HOSTNAME}_${TIMESTAMP}.gz"

# Membuat direktori backup jika belum ada
mkdir -p "$BACKUP_DIR"

echo "----------------------------------------------------------"
echo "ğŸš€ Memulai Backup MongoDB (User Database Only)"
echo "ğŸ“… Waktu  : $(date)"
echo "Host      : 127.0.0.1"
echo "Archive   : $ARCHIVE_FILE"
echo "----------------------------------------------------------"

# 1. Mendapatkan daftar database aplikasi (Filter out System DB)
echo "ğŸ” Mengidentifikasi database aplikasi..."
DB_LIST=$(mongosh --host 127.0.0.1 -u "$DKA_MONGO_USERNAME" -p "$DKA_MONGO_PASSWORD" \
          --authenticationDatabase admin --quiet \
          --eval "db.getMongo().getDBNames().filter(d => !['admin', 'config', 'local'].includes(d)).join(' ')")

if [ -z "$DB_LIST" ]; then
    echo "âš ï¸ Tidak ditemukan database aplikasi untuk di-backup!"
    exit 0
fi

echo "ğŸ“¦ Database ditemukan: $DB_LIST"

# 2. Menyusun argumen database untuk mongodump
DUMP_ARGS=""
for db in $DB_LIST; do
    DUMP_ARGS="$DUMP_ARGS --db $db"
done

# 3. Melakukan backup tanpa membawa data Auth/System
echo "Proses: Dumping data ke $ARCHIVE_FILE..."

if mongodump --host 127.0.0.1 \
    --username "$DKA_MONGO_USERNAME" \
    --password "$DKA_MONGO_PASSWORD" \
    --authenticationDatabase admin \
    $DUMP_ARGS \
    --gzip \
    --archive="$BACKUP_DIR/$ARCHIVE_FILE"; then

    echo "âœ… Backup Berhasil: $ARCHIVE_FILE"
    echo "ğŸ“Š Ukuran File: $(du -sh "$BACKUP_DIR/$ARCHIVE_FILE" | cut -f1)"
else
    echo "âŒ Backup GAGAL!" >&2
    exit 1
fi

echo "----------------------------------------------------------"

# 4. Membersihkan backup yang usianya lebih dari 7 hari
echo "ğŸ§¹ Mengecek file backup lama (di atas 7 hari)..."

FILES_TO_DELETE=$(find "$BACKUP_DIR" -type f -name "*.gz" -mtime +7)

if [ -n "$FILES_TO_DELETE" ]; then
    echo "Ditemukan file lama:"
    echo "$FILES_TO_DELETE"
    find "$BACKUP_DIR" -type f -name "*.gz" -mtime +7 -delete
    echo "ğŸ—‘ï¸ File lama berhasil dihapus."
else
    echo "âœ¨ Tidak ada file backup yang lebih dari 7 hari. Skip pembersihan."
fi

echo "----------------------------------------------------------"
echo "ğŸ Selesai!"
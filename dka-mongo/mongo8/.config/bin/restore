#!/bin/bash
# Script Restore MongoDB - Sinkron dengan Script Backup (Exclude System DB)

# --- KONFIGURASI ---
DKA_MONGO_USERNAME=${DKA_MONGO_USERNAME:-root}
DKA_MONGO_PASSWORD=${DKA_MONGO_PASSWORD:-123456789}
BACKUP_DIR="/backup"

# Ambil daftar file .gz, urutkan berdasarkan waktu modifikasi (terbaru di atas)
# shellcheck disable=SC2012
BACKUP_FILES=($(ls -1t $BACKUP_DIR/*.gz 2>/dev/null | head -n 50))

if [ ${#BACKUP_FILES[@]} -eq 0 ]; then
    echo "âŒ Tidak ada file backup tersedia di $BACKUP_DIR"
    exit 1
fi

echo "----------------------------------------------------------"
echo "ðŸ“‚ Daftar 50 Backup Terakhir:"
echo "----------------------------------------------------------"

MENU_OPTIONS=()
for file in "${BACKUP_FILES[@]}"; do
    FILE_SIZE=$(du -h "$file" | awk '{print $1}')
    MENU_OPTIONS+=("$(basename "$file") ($FILE_SIZE)")
done

PS3="ðŸ‘‰ Pilih nomor file (1-${#MENU_OPTIONS[@]}): "

select CHOICE in "${MENU_OPTIONS[@]}"; do
    if [ -n "$CHOICE" ]; then
        # Mengambil path lengkap file dari array berdasarkan pilihan user
        SELECTED_BACKUP_PATH="${BACKUP_FILES[$((REPLY-1))]}"
        break
    else
        echo "âš ï¸ Pilihan tidak valid, silakan pilih nomor yang tersedia."
    fi
done

echo "----------------------------------------------------------"
echo "ðŸ”„ Memulai Restore: $(basename "$SELECTED_BACKUP_PATH")"
echo "----------------------------------------------------------"

# Perintah restore yang sinkron:
# --verbose: Agar log detail setiap collection terlihat
# --authenticationDatabase admin: Wajib karena kita login pakai user root
# --drop: Menghapus data lama sebelum ditimpa agar tidak duplikat/error
mongorestore --host 127.0.0.1 \
    --username "$DKA_MONGO_USERNAME" \
    --password "$DKA_MONGO_PASSWORD" \
    --authenticationDatabase admin \
    --verbose \
    --drop \
    --gzip \
    --archive="$SELECTED_BACKUP_PATH"

# Cek apakah eksekusi mongorestore berhasil
if [ $? -eq 0 ]; then
    echo "----------------------------------------------------------"
    echo "âœ… Restore selesai dengan sukses!"
    echo "----------------------------------------------------------"
else
    echo "----------------------------------------------------------"
    echo "âŒ Restore GAGAL!" >&2
    echo "----------------------------------------------------------"
    exit 1
fi